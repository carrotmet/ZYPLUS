<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ability Assessment 测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input[type="range"] { width: 200px; }
    </style>
</head>
<body>
    <h1>Ability Assessment 调试测试页面</h1>
    
    <div class="test-section info">
        <h3>测试说明</h3>
        <p>这个页面用于测试 ability_assessment 的保存和加载功能。</p>
        <ol>
            <li>调整下面的滑块</li>
            <li>点击"测试提交数据"查看将要提交的数据</li>
            <li>在用户画像页面打开表单，调整能力自评滑块</li>
            <li>查看浏览器控制台的调试日志</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>模拟能力自评滑块</h3>
        <div>
            <label>逻辑推理: <span id="logic-value">5</span></label><br>
            <input type="range" id="logic" min="1" max="10" value="5" oninput="updateValue('logic', this.value)">
        </div>
        <div style="margin-top: 10px;">
            <label>创造力: <span id="creativity-value">5</span></label><br>
            <input type="range" id="creativity" min="1" max="10" value="5" oninput="updateValue('creativity', this.value)">
        </div>
        <div style="margin-top: 10px;">
            <label>沟通能力: <span id="communication-value">5</span></label><br>
            <input type="range" id="communication" min="1" max="10" value="5" oninput="updateValue('communication', this.value)">
        </div>
    </div>

    <div class="test-section">
        <h3>测试功能</h3>
        <button onclick="testDataCollection()">测试数据收集</button>
        <button onclick="testDeepCopy()">测试深拷贝</button>
        <button onclick="checkProfileFormState()">检查 ProfileFormState</button>
        <button onclick="clearConsole()">清空控制台</button>
    </div>

    <div class="test-section">
        <h3>测试结果</h3>
        <div id="results"></div>
    </div>

    <script src="../profile-form.js"></script>
    <script>
        // 模拟 ProfileFormState 的行为
        let testCurrentData = {};
        let testOriginalData = {};

        function updateValue(key, value) {
            document.getElementById(key + '-value').textContent = value;
            
            // 模拟 handleSliderGroupChange 的行为
            const current = { ...(testCurrentData.ability_assessment || {}) };
            current[key] = parseInt(value);
            testCurrentData.ability_assessment = current;
            
            console.log(`[Test] ${key} changed to ${value}:`, testCurrentData.ability_assessment);
        }

        function testDataCollection() {
            console.log('=== 测试数据收集 ===');
            console.log('testCurrentData:', testCurrentData);
            console.log('testOriginalData:', testOriginalData);
            
            const changes = {};
            for (const key in testCurrentData) {
                const currentVal = testCurrentData[key];
                const originalVal = testOriginalData[key];
                const isDifferent = JSON.stringify(currentVal) !== JSON.stringify(originalVal);
                console.log(`${key}: current=${JSON.stringify(currentVal)}, original=${JSON.stringify(originalVal)}, changed=${isDifferent}`);
                if (isDifferent) {
                    changes[key] = currentVal;
                }
            }
            
            console.log('Changes detected:', changes);
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="test-section ${Object.keys(changes).length > 0 ? 'success' : 'error'}">
                    <h4>变更检测结果</h4>
                    <pre>${JSON.stringify(changes, null, 2)}</pre>
                    <p>检测到 ${Object.keys(changes).length} 个变更字段</p>
                </div>
            `;
        }

        function testDeepCopy() {
            console.log('=== 测试深拷贝 ===');
            
            // 测试浅拷贝问题
            const original = { ability_assessment: { logic: 5 } };
            const shallowCopy = { ...original };
            const deepCopy = JSON.parse(JSON.stringify(original));
            
            // 修改拷贝的数据
            shallowCopy.ability_assessment.logic = 8;
            deepCopy.ability_assessment.logic = 9;
            
            console.log('Original after shallow modify:', original);
            console.log('Shallow copy:', shallowCopy);
            console.log('Deep copy:', deepCopy);
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="test-section info">
                    <h4>深拷贝测试结果</h4>
                    <p><strong>Original:</strong> ability_assessment.logic = ${original.ability_assessment.logic}</p>
                    <p><strong>浅拷贝修改后，Original 也被改变了！</strong></p>
                    <p>这说明必须使用深拷贝来避免引用问题。</p>
                </div>
            `;
        }

        function checkProfileFormState() {
            console.log('=== 检查 ProfileFormState ===');
            console.log('ProfileFormState:', ProfileFormState);
            console.log('currentData:', ProfileFormState.currentData);
            console.log('originalData:', ProfileFormState.originalData);
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="test-section info">
                    <h4>ProfileFormState 状态</h4>
                    <p>isOpen: ${ProfileFormState.isOpen}</p>
                    <p>userId: ${ProfileFormState.userId || 'null'}</p>
                    <pre>currentData: ${JSON.stringify(ProfileFormState.currentData, null, 2)}</pre>
                    <pre>originalData: ${JSON.stringify(ProfileFormState.originalData, null, 2)}</pre>
                </div>
            `;
        }

        function clearConsole() {
            console.clear();
            document.getElementById('results').innerHTML = '<p>控制台已清空</p>';
        }

        // 初始化
        testOriginalData = { ability_assessment: { logic: 5, creativity: 5, communication: 5 } };
        testCurrentData = JSON.parse(JSON.stringify(testOriginalData));
        
        console.log('测试页面已加载');
        console.log('初始数据:', testCurrentData);
    </script>
</body>
</html>
