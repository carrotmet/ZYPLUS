# 代码问题报告

## 一、JavaScript文件问题

### 1. main.js

#### 问题1：重复的数据定义（严重）
- **位置**: 第307-537行
- **描述**: `useMockData()` 函数中，`disciplines` 数组被重复定义了两次（第74-212行和第307-443行）
- **影响**: 代码冗余，可能导致数据不一致
- **建议**: 删除重复的代码块

#### 问题2：变量命名不一致（中等）
- **位置**: 第271行
- **描述**: `experience_max` 和 `avg_salary` 使用下划线命名，但其他字段使用驼峰命名（`experienceMin`, `experienceMax`, `avgSalary`）
- **影响**: 代码风格不一致，可能导致混淆
- **建议**: 统一使用驼峰命名或下划线命名

#### 问题3：未定义的event变量（严重）
- **位置**: 第616行
```javascript
function selectMajor(major) {
    selectedMajor = major;
    renderMajorDetails(major);
    
    // 更新树项选中状态
    document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');  // ❌ event未定义
}
```
- **描述**: `event.target` 被使用但 `event` 参数未传入函数
- **影响**: 会导致运行时错误
- **建议**: 在函数中接收event参数，或通过其他方式获取目标元素

#### 问题4：API路径不一致（中等）
- **位置**: 第665行
- **描述**: 跳转链接使用了 `major-detail.html?occupation=${occupation.id}`，但应该使用正确的页面路径
- **影响**: 可能导致页面跳转错误

### 2. add-info.js

#### 问题1：XSS安全风险（中等）
- **位置**: 第163行、199行、239行、288行
- **描述**: 使用 `innerHTML` 直接插入用户输入内容，虽然使用了 `escape`，但可能不够安全
- **影响**: 潜在的XSS攻击风险
- **建议**: 使用 `textContent` 或更安全的DOM操作方法

#### 问题2：标签删除功能中的HTML注入风险（中等）
- **位置**: 第163行、199行
```javascript
tag.innerHTML = `
    ${course}
    <button type="button" onclick="removeMajorCourse('${course}')">×</button>
`;
```
- **描述**: 如果course包含单引号，会导致JavaScript语法错误或注入攻击
- **影响**: 可能导致功能异常或安全漏洞
- **建议**: 使用事件委托或转义特殊字符

#### 问题3：数据字段名不一致（中等）
- **位置**: 第452-453行
```javascript
salaryMin: occupationData.salary_min,
salaryMax: occupationData.salary_max,
```
- **描述**: 创建职业时，后端返回的是 `salary_min` 和 `salary_max`，但前端期望 `salaryMin` 和 `salaryMax`
- **影响**: 可能导致数据映射错误

### 3. api-service.js

#### 问题1：API路径错误（中等）
- **位置**: 第238行
```javascript
const response = await this.request(`/api/experiences/shares/${shareId}/like`, {
```
- **描述**: 路径中包含了 `/api`，但 `baseURL` 已经是 `http://localhost:8000/api`，导致路径变成 `/api/api/...`
- **影响**: API请求失败
- **建议**: 移除路径中的 `/api` 前缀

#### 问题2：错误处理不完善（轻微）
- **位置**: 多处
- **描述**: 所有API调用都使用try-catch，但错误处理只是返回模拟数据，没有向用户提示API不可用
- **影响**: 用户可能不知道API服务不可用
- **建议**: 添加用户友好的错误提示

## 二、HTML文件问题

### 1. index.html

#### 问题1：可疑的外部链接（严重）
- **位置**: 第2行
```html
<base href="https://fwpg7nn7o7qas.ok.kimi.link">
```
- **描述**: 存在指向外部域名的base标签，这可能导致资源加载错误
- **影响**: 可能导致页面资源加载失败，存在安全风险
- **建议**: 删除或修改为正确的base路径

#### 问题2：未使用的外部脚本（轻微）
- **位置**: 第127行
```html
<script src="https://statics.moonshot.cn/sdk/preview-widgets.min.js" defer=""></script>
```
- **描述**: 引入了外部SDK但代码中未使用
- **影响**: 不必要的资源加载
- **建议**: 如果不需要，删除该脚本

#### 问题3：缺少api-service.js引用（严重）
- **位置**: 第286行
- **描述**: `main.js` 中使用了 `window.apiService`，但HTML文件中没有引入 `api-service.js`
- **影响**: API服务无法加载，只能使用模拟数据
- **建议**: 在 `main.js` 之前添加 `<script src="api-service.js"></script>`

### 2. major-detail.html

#### 问题1：未定义的event变量（严重）
- **位置**: 第439行
```javascript
function selectOccupation(occupation) {
    selectedOccupation = occupation;
    
    // 更新卡片选中状态
    document.querySelectorAll('.occupation-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');  // ❌ event未定义
```
- **描述**: `event.currentTarget` 被使用但 `event` 未定义
- **影响**: 会导致运行时错误
- **建议**: 修改函数签名接收event参数，或通过其他方式获取currentTarget

#### 问题2：缺少API服务文件引用（中等）
- **描述**: 如果需要在major-detail.html中使用API服务，需要引入api-service.js
- **影响**: 无法使用真实API数据

### 3. experience-sharing.html

#### 问题1：缺少api-service.js引用（中等）
- **描述**: 代码中使用了 `window.apiService`，但HTML文件中没有引入
- **影响**: 无法使用真实API数据

## 三、Python后端文件问题

### 1. main.py

#### 问题1：CORS配置过于宽松（严重）
- **位置**: 第21-27行
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ❌ 生产环境安全风险
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```
- **描述**: 允许所有来源的请求，存在安全风险
- **影响**: 生产环境可能被恶意网站利用
- **建议**: 在生产环境中限制允许的域名

#### 问题2：初始化接口返回格式不一致（中等）
- **位置**: 第186行
```python
@app.post("/api/init-data")
def init_database(db: Session = Depends(get_db)):
```
- **描述**: 返回格式不是标准的 `ResponseModel`，与其他接口不一致
- **影响**: 前端处理可能需要特殊逻辑
- **建议**: 统一使用 `ResponseModel` 包装返回数据

#### 问题3：错误处理不完善（中等）
- **位置**: 第330行
```python
except Exception as e:
    return {"error": str(e)}
```
- **描述**: 异常处理直接返回错误信息，没有使用HTTPException
- **影响**: 错误响应格式不一致
- **建议**: 使用HTTPException返回标准错误响应

#### 问题4：缺少API路径前缀（中等）
- **位置**: 第30行
```python
@app.get("/")
def read_root():
```
- **描述**: 根路径没有 `/api` 前缀，但其他所有接口都有
- **影响**: 路径不一致，可能导致前端调用错误
- **建议**: 统一所有路径使用 `/api` 前缀或都不使用

### 2. crud.py

#### 问题1：缺少数据验证（中等）
- **位置**: 多处
- **描述**: CRUD操作没有验证输入数据的有效性（如外键是否存在）
- **影响**: 可能导致数据不一致或数据库错误
- **建议**: 添加数据验证逻辑

#### 问题2：缺少事务处理（轻微）
- **位置**: 多处
- **描述**: 某些操作可能涉及多个表的更新，但没有使用事务
- **影响**: 可能导致数据不一致
- **建议**: 对复杂操作使用事务

### 3. database.py

#### 问题1：JSON字段存储方式不当（严重）
- **位置**: 第63行、79行
```python
main_courses = Column(Text)  # 主要课程（JSON格式）
requirements = Column(Text)  # 要求（JSON格式）
```
- **描述**: 使用Text存储JSON，但需要使用JSON库解析，容易出错
- **影响**: 
  - 数据存储和读取需要手动序列化/反序列化
  - 无法利用数据库的JSON查询功能
  - 容易出现数据格式错误
- **建议**: 使用SQLAlchemy的JSON类型或PostgreSQL的JSONB类型

#### 问题2：缺少数据库索引（中等）
- **位置**: 多处
- **描述**: 外键字段和常用查询字段没有索引
- **影响**: 查询性能可能较差
- **建议**: 为常用查询字段添加索引

#### 问题3：数据库路径硬编码（轻微）
- **位置**: 第8-12行
- **描述**: 数据库路径使用硬编码的相对路径
- **影响**: 部署时可能找不到数据库文件
- **建议**: 使用环境变量或配置文件

### 4. schemas.py

#### 问题1：数据模型与数据库不匹配（严重）
- **位置**: 第57行、77行
```python
main_courses: List[str] = Field(default_factory=list, description="主要课程")
requirements: List[str] = Field(default_factory=list, description="要求")
```
- **描述**: Schema定义中 `main_courses` 和 `requirements` 是 `List[str]`，但数据库中存储为 `Text`（JSON字符串）
- **影响**: 
  - 需要手动处理序列化/反序列化
  - 容易出现数据格式不匹配错误
- **建议**: 
  1. 修改数据库模型使用JSON类型
  2. 或在CRUD操作中正确处理序列化/反序列化

#### 问题2：缺少数据验证器（中等）
- **位置**: 多处
- **描述**: 虽然使用了Pydantic，但缺少自定义验证器（如验证专业代码格式、薪资范围等）
- **影响**: 可能接受无效数据
- **建议**: 添加适当的验证器

### 5. test-api.py

#### 问题1：缺少错误处理（轻微）
- **位置**: 多处
- **描述**: 测试脚本中某些变量可能未定义（如 `discipline_id`、`major_id` 等）
- **影响**: 如果API返回空数据，后续测试会失败
- **建议**: 添加条件检查，确保变量存在后再使用

## 四、总结

### 严重问题（必须修复）
1. main.js中重复的数据定义
2. main.js和major-detail.html中未定义的event变量
3. index.html中可疑的外部base链接
4. database.py中JSON字段存储方式不当
5. schemas.py中数据模型与数据库不匹配

### 中等问题（建议修复）
1. JavaScript文件中的XSS安全风险
2. API路径不一致问题
3. CORS配置过于宽松
4. 缺少API服务文件引用
5. 数据字段命名不一致

### 轻微问题（可选修复）
1. 未使用的外部脚本
2. 错误处理不完善
3. 缺少数据验证和索引

## 五、修复优先级

### 高优先级
1. 修复未定义的event变量
2. 修复JSON字段存储方式
3. 删除可疑的外部链接
4. 添加缺少的API服务文件引用

### 中优先级
1. 统一数据字段命名
2. 修复API路径问题
3. 改进CORS配置
4. 添加数据验证

### 低优先级
1. 清理未使用的代码
2. 优化错误处理
3. 添加数据库索引

