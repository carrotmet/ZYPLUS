# 用户报告模块设计文档

> **文档版本**: v1.0  
> **创建日期**: 2026-02-09  
> **最后更新**: 2026-02-09  
> **设计依据**: Career-Planning Skill v1.1, code-design-description Skill

---

## 一、设计概述

### 1.1 模块定位

用户报告模块是职业规划导航平台的核心功能模块之一，与**专业选择模块**、**职业详情模块**并列，构成平台的三大核心功能支柱。该模块基于用户画像数据、已填表单信息、三层职业规划结构化模型和分层递进行动体系，生成全面、专业、个性化的职业规划完整报告。

### 1.2 设计目标

| 目标维度 | 具体要求 |
|---------|---------|
| **内容深度** | 报告总字数 ≥ 50,000字，各章节字数分配明确 |
| **结构清晰** | 模块化设计，支持整体报告和子报告独立输出 |
| **逻辑严谨** | 基于Career-Planning Skill的三层模型和分层行动体系 |
| **技术先进** | 采用LazyLLM并行工作流实现高效报告生成 |
| **用户体验** | 支持实时生成进度展示、报告预览、多格式导出 |

### 1.3 核心概念说明

#### 1.3.1 三层职业规划结构化模型

根据Career-Planning Skill，职业规划结构化模型分为三层：

```
┌─────────────────────────────────────────────────────────────────┐
│ LAYER 3: 接口层 (Interface Layer) - 个性化输入                    │
│ ├── 个人兴趣与价值观 (Interest & Values)                          │
│ ├── 能力优势与发展空间 (Ability & Potential)                       │
│ ├── 家庭背景与资源 (Family Background & Resources)                 │
│ └── 生活目标与约束 (Life Goals & Constraints)                      │
├─────────────────────────────────────────────────────────────────┤
│ LAYER 2: 可变层 (Variable Layer) - 专业适配要素                   │
│ ├── 专业理论体系 (Professional Theory System)                      │
│ ├── 职业路径分化 (Career Path Differentiation)                     │
│ ├── 实践途径组合 (Practice Pathway Combination)                    │
│ └── 终身学习机制 (Lifelong Learning Mechanism)                     │
├─────────────────────────────────────────────────────────────────┤
│ LAYER 1: 核心层 (Core Layer) - 跨专业不变要素                     │
│ ├── 自我认知与职业探索方法                                          │
│ ├── 决策加工与执行保障 (CASVE Cycle)                                │
│ ├── 通用技能发展矩阵 (Universal Skills Matrix)                      │
│ └── 职业弹性与适应策略 (Career Resilience)                          │
└─────────────────────────────────────────────────────────────────┘
```

#### 1.3.2 分层递进行动体系

```
┌─────────────────────────────────────────────────────────────────┐
│ LAYER 4: 终身学习系统嵌入                                         │
│ ├── 学习机制: 结构化学习/项目驱动/社区学习/反思学习                 │
│ ├── 资源配置: 在线课程/技术社区/专业书籍/会议活动                   │
│ └── 效果评估: 知识掌握/技能发展/能力提升/成果产出                   │
├─────────────────────────────────────────────────────────────────┤
│ LAYER 3: 实践途径多元化配置                                        │
│ ├── 竞赛参与: 学科竞赛/算法竞赛/创新创业/设计竞赛                   │
│ ├── 项目实践: 课程项目 → 开源贡献 → 个人作品                        │
│ ├── 实习体验: 探索性 → 专业性 → 战略性                              │
│ └── 学术深造: 本科科研 → 硕博连读 → 博士后                          │
├─────────────────────────────────────────────────────────────────┤
│ LAYER 2: 核心能力构建层                                            │
│ ├── 专业理论: 基础模块(高稳定) + 应用模块(中稳定) + 前沿模块(低稳定) │
│ ├── 通用技能: 沟通/协作/批判思维/创造力                             │
│ └── 自我管理: 时间管理/情绪调节/职业弹性                            │
├─────────────────────────────────────────────────────────────────┤
│ LAYER 1: 自我认知与职业探索层                                       │
│ ├── 标准化测评: Holland/MBTI/能力倾向/价值观                        │
│ ├── 职业信息: 工作内容/能力要求/发展前景/工作环境                   │
│ └── 实践探索: 信息访谈/岗位Shadowing/企业参访                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、模块架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户报告模块 (User Report Module)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │
│  │   报告展示模块       │  │   报告生成模块       │  │   报告导出模块       │  │
│  │   Report Display    │  │   Report Generation │  │   Report Export     │  │
│  │                     │  │                     │  │                     │  │
│  │ • 报告列表页         │  │ • 生成条件检查       │  │ • PDF导出           │  │
│  │ • 报告阅读器         │  │ • 章节并行生成       │  │ • Word导出          │  │
│  │ • 章节导航           │  │ • 内容质量校验       │  │ • Markdown导出      │  │
│  │ • 交互式图表         │  │ • 报告组装引擎       │  │ • 打印优化          │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  │
│           │                        │                        │               │
│           └────────────────────────┼────────────────────────┘               │
│                                    │                                        │
│                              ┌─────┴─────┐                                  │
│                              │ 报告存储层 │                                  │
│                              │ Report DB │                                  │
│                              └───────────┘                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统已有模块                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  用户画像模块 │  │  用户表单模块 │  │  专业选择模块 │  │  职业详情模块 │     │
│  │ User Profile │  │  User Forms  │  │Major Selector│  │ Occupation   │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │                 │             │
│         └─────────────────┴─────────────────┴─────────────────┘             │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        数据聚合层 (Data Aggregation)                  │    │
│  │  • 用户画像数据 (接口层/可变层/核心层)                                  │    │
│  │  • 表单填写历史 (Holland/MBTI/价值观/能力评估)                          │    │
│  │  • 专业偏好记录 (preferred_disciplines/preferred_majors)               │    │
│  │  • 实践经历数据 (practice_experiences)                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        用户报告模块 (User Report Module)              │    │
│  │                                                                     │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │    │
│  │  │  报告生成模块    │  │  报告展示模块    │  │  报告导出模块    │      │    │
│  │  │ Report Generator│  │ Report Display  │  │  Report Export  │      │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘      │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        报告输出 (Report Output)                       │    │
│  │  • 子报告A: 用户画像分析报告 (8,000+字)                                │    │
│  │  • 子报告B: 用户表单分析报告 (6,000+字)                                │    │
│  │  • 子报告C: 三层职业规划建模报告 (15,000+字)                           │    │
│  │  • 子报告D: 分层递进行动体系报告 (12,000+字)                           │    │
│  │  • 完整报告: 综合职业规划报告 (50,000+字)                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 报告生成模块核心架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         报告生成模块核心架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     生成条件检查器 (Prerequisites Checker)            │    │
│  │                                                                     │    │
│  │  子报告A条件: 接口层完整度 ≥ 60% (holland_code + mbti_type + 1项)      │    │
│  │  子报告B条件: 表单填写次数 ≥ 3 或 核心层casve_stage有值               │    │
│  │  子报告C条件: 可变层完整度 ≥ 50% (career_path + preferred_majors)     │    │
│  │  子报告D条件: 核心层universal_skills不为空                            │    │
│  │  完整报告条件: 以上所有条件 + 总完整度 ≥ 70%                          │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ▼ (条件满足)                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     LazyLLM 并行生成工作流                             │    │
│  │                                                                     │    │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │    │
│  │   │  章节1生成   │  │  章节2生成   │  │  章节3生成   │  │   ...      │ │    │
│  │   │ Chapter 1   │  │ Chapter 2   │  │ Chapter 3   │  │            │ │    │
│  │   │ Generator   │  │ Generator   │  │ Generator   │  │            │ │    │
│  │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘ │    │
│  │          │                │                │               │        │    │
│  │          └────────────────┴────────────────┴───────────────┘        │    │
│  │                                   │                                  │    │
│  │                                   ▼                                  │    │
│  │   ┌─────────────────────────────────────────────────────────────┐   │    │
│  │   │              并行结果聚合 (Parallel Result Aggregator)        │   │    │
│  │   │                                                             │   │    │
│  │   │  pipeline(                                                  │   │    │
│  │   │      parallel(ch1_gen, ch2_gen, ch3_gen, ...),              │   │    │
│  │   │      quality_validator,     // 质量校验                      │   │    │
│  │   │      content_assembler      // 内容组装                      │   │    │
│  │   │  )                                                          │   │    │
│  │   │                                                             │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     报告组装引擎 (Report Assembler)                   │    │
│  │                                                                     │    │
│  │  • 章节排序与合并                                                      │    │
│  │  • 目录生成                                                           │    │
│  │  • 引用与附录整理                                                      │    │
│  │  • 格式统一处理                                                        │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     报告存储与版本管理                                 │    │
│  │                                                                     │    │
│  │  • 报告元数据存储 (report_metadata表)                                 │    │
│  │  • 报告内容存储 (report_content表)                                    │    │
│  │  • 章节内容存储 (report_chapters表)                                   │    │
│  │  • 版本控制 (支持重新生成对比)                                         │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、报告结构设计

### 3.1 完整报告结构 (预期50,000+字)

```
职业规划完整报告
│
├── 封面与元信息 (500字)
│   ├── 报告标题与用户信息
│   ├── 生成日期与版本
│   └── 免责声明与使用建议
│
├── 第一章: 执行摘要 (2,000字)
│   ├── 1.1 报告概览
│   ├── 1.2 核心发现摘要
│   ├── 1.3 关键建议概览
│   └── 1.4 阅读指南
│
├── 第二章: 用户画像深度分析 (8,000字) ← 子报告A
│   ├── 2.1 接口层画像解析
│   │   ├── 2.1.1 Holland职业兴趣分析 (2,000字)
│   │   │   ├── 代码解读与类型特征
│   │   │   ├── 适配职业领域分析
│   │   │   └── 发展建议
│   │   ├── 2.1.2 MBTI性格类型分析 (2,000字)
│   │   │   ├── 类型特征详解
│   │   │   ├── 职业匹配度分析
│   │   │   └── 团队协作建议
│   │   ├── 2.1.3 价值观优先级分析 (1,500字)
│   │   └── 2.1.4 能力评估矩阵 (1,500字)
│   ├── 2.2 可变层画像解析
│   │   ├── 2.2.1 偏好学科分析 (500字)
│   │   └── 2.2.2 职业路径倾向 (500字)
│   └── 2.3 三层画像综合解读 (1,000字)
│
├── 第三章: 用户表单与交互分析 (6,000字) ← 子报告B
│   ├── 3.1 表单填写历史回顾 (1,500字)
│   ├── 3.2 数据一致性与演变分析 (1,500字)
│   ├── 3.3 CASVE决策阶段追踪 (2,000字)
│   │   ├── 当前阶段定位
│   │   ├── 阶段特征分析
│   │   └── 下一阶段行动建议
│   └── 3.4 用户关注焦点识别 (1,000字)
│
├── 第四章: 三层职业规划结构化建模 (15,000字) ← 子报告C
│   ├── 4.1 接口层建模: 个性化输入系统 (4,000字)
│   │   ├── 4.1.1 兴趣-职业映射模型
│   │   ├── 4.1.2 能力-发展潜能评估
│   │   ├── 4.1.3 价值观-工作满意度预测
│   │   └── 4.1.4 约束条件影响分析
│   ├── 4.2 可变层建模: 专业适配系统 (6,000字)
│   │   ├── 4.2.1 专业理论体系适配
│   │   │   ├── 基础理论模块匹配
│   │   │   ├── 应用技术模块匹配
│   │   │   └── 前沿趋势模块匹配
│   │   ├── 4.2.2 职业路径分化分析
│   │   │   ├── 技术专家路径评估
│   │   │   ├── 管理领导路径评估
│   │   │   ├── 第三路径评估
│   │   │   └── 公益性路径评估
│   │   ├── 4.2.3 实践途径组合设计
│   │   └── 4.2.4 终身学习机制规划
│   └── 4.3 核心层建模: 跨专业能力系统 (5,000字)
│       ├── 4.3.1 自我认知与探索方法体系
│       ├── 4.3.2 CASVE决策加工模型
│       ├── 4.3.3 通用技能发展矩阵
│       └── 4.3.4 职业弹性与适应策略
│
├── 第五章: 分层递进行动体系设计 (12,000字) ← 子报告D
│   ├── 5.1 Layer 1: 自我认知与职业探索行动计划 (3,000字)
│   │   ├── 5.1.1 标准化测评深化计划
│   │   ├── 5.1.2 职业信息搜集计划
│   │   └── 5.1.3 实践探索行动计划
│   ├── 5.2 Layer 2: 核心能力构建行动计划 (3,000字)
│   │   ├── 5.2.1 专业理论学习计划
│   │   ├── 5.2.2 通用技能培养计划
│   │   └── 5.2.3 自我管理能力提升计划
│   ├── 5.3 Layer 3: 实践途径多元化配置计划 (3,000字)
│   │   ├── 5.3.1 竞赛参与规划
│   │   ├── 5.3.2 项目实践规划
│   │   ├── 5.3.3 实习体验规划
│   │   └── 5.3.4 学术深造规划
│   └── 5.4 Layer 4: 终身学习系统嵌入计划 (3,000字)
│       ├── 5.4.1 学习机制建立
│       ├── 5.4.2 学习资源配置
│       └── 5.4.3 学习效果评估体系
│
├── 第六章: 职业发展路径推荐 (4,000字)
│   ├── 6.1 短期路径 (1-2年)
│   ├── 6.2 中期路径 (3-5年)
│   ├── 6.3 长期路径 (5-10年)
│   └── 6.4 路径切换预案
│
├── 第七章: 风险评估与应对策略 (2,500字)
│   ├── 7.1 内部风险识别
│   ├── 7.2 外部风险识别
│   └── 7.3 应对策略与预案
│
└── 附录 (2,000+字)
    ├── 附录A: 参考文献与资源
    ├── 附录B: 专业术语表
    ├── 附录C: 工具与模板
    └── 附录D: 报告生成元数据
```

### 3.2 子报告字数分配表

| 子报告 | 报告名称 | 字数要求 | 核心依赖 |
|--------|---------|---------|---------|
| **子报告A** | 用户画像深度分析报告 | ≥ 8,000字 | 接口层完整度 ≥ 60% |
| **子报告B** | 用户表单分析报告 | ≥ 6,000字 | 表单填写次数 ≥ 3 |
| **子报告C** | 三层职业规划建模报告 | ≥ 15,000字 | 可变层完整度 ≥ 50% |
| **子报告D** | 分层递进行动体系报告 | ≥ 12,000字 | 核心层universal_skills有值 |
| **完整报告** | 职业规划完整报告 | ≥ 50,000字 | 所有子报告条件 + 总完整度 ≥ 70% |

---

## 四、LazyLLM并行生成工作流设计

### 4.1 工作流架构

参考 lazyllm-workflow-design Skill，采用 `parallel + pipeline` 组合模式：

```python
# 伪代码示意
from lazyllm import pipeline, parallel, switch, loop

report_generation_flow = pipeline(
    # Stage 1: 数据准备与条件检查
    data_preparation_module,
    
    # Stage 2: 并行章节生成 (核心)
    parallel(
        chapter_2_1_generator,   # Holland分析
        chapter_2_2_generator,   # MBTI分析
        chapter_2_3_generator,   # 价值观分析
        chapter_2_4_generator,   # 能力评估
        chapter_3_generator,     # 表单分析
        chapter_4_1_generator,   # 接口层建模
        chapter_4_2_generator,   # 可变层建模
        chapter_4_3_generator,   # 核心层建模
        chapter_5_1_generator,   # Layer 1行动
        chapter_5_2_generator,   # Layer 2行动
        chapter_5_3_generator,   # Layer 3行动
        chapter_5_4_generator,   # Layer 4行动
        chapter_6_generator,     # 路径推荐
        chapter_7_generator,     # 风险评估
        _concurrency=5           # 最多5个并行
    ),
    
    # Stage 3: 质量校验
    quality_validator,
    
    # Stage 4: 报告组装
    report_assembler,
    
    # Stage 5: 元数据记录
    metadata_recorder
)
```

### 4.2 章节生成器设计

每个章节生成器是一个独立的LLM调用模块：

```python
# 章节生成器模板
class ChapterGenerator:
    """报告章节生成器基类"""
    
    def __init__(self, chapter_config: dict):
        self.chapter_id = chapter_config['id']
        self.chapter_title = chapter_config['title']
        self.word_count = chapter_config['word_count']
        self.prompt_template = chapter_config['prompt_template']
        self.llm = OnlineChatModule(
            model=KIMI,
            stream=True,
            return_trace=True
        )
    
    def __call__(self, user_data: dict) -> dict:
        """生成章节内容"""
        # 1. 构建prompt
        prompt = self._build_prompt(user_data)
        
        # 2. 调用LLM生成
        content = self.llm(prompt)
        
        # 3. 字数校验
        actual_words = len(content)
        if actual_words < self.word_count * 0.8:  # 字数不足
            content = self._expand_content(content, user_data)
        
        # 4. 返回结构化结果
        return {
            'chapter_id': self.chapter_id,
            'chapter_title': self.chapter_title,
            'content': content,
            'word_count': actual_words,
            'status': 'completed'
        }
```

### 4.3 生成进度追踪

```
生成任务状态流转:

    [pending] → [validating] → [generating] → [quality_check] → [completed]
                  │                │                │
                  ▼                ▼                ▼
              [failed_prereq]  [retry]          [needs_revision]
                  │                │                │
                  └────────────────┴────────────────┘
                                   │
                                   ▼
                              [failed]
```

---

## 五、生成条件限制设计

### 5.1 条件检查矩阵

| 报告类型 | 条件ID | 条件描述 | 检查逻辑 | 不满足提示 |
|---------|--------|---------|---------|-----------|
| 子报告A | A1 | 接口层基础信息 | `holland_code IS NOT NULL AND mbti_type IS NOT NULL` | "请先完成Holland职业兴趣测评和MBTI性格测试" |
| 子报告A | A2 | 接口层完整度 | `interface_completeness >= 60` | "接口层完整度不足，请完善价值观或能力评估" |
| 子报告B | B1 | 表单填写次数 | `form_submission_count >= 3` | "表单填写次数不足，请至少完成3次表单更新" |
| 子报告B | B2 | CASVE阶段 | `current_casve_stage IS NOT NULL` | "请先确定您的CASVE决策阶段" |
| 子报告C | C1 | 可变层路径偏好 | `career_path_preference IS NOT NULL` | "请设置您的职业路径偏好" |
| 子报告C | C2 | 可变层专业偏好 | `preferred_majors IS NOT NULL AND length(preferred_majors) > 0` | "请至少选择一个感兴趣的专业" |
| 子报告C | C3 | 可变层完整度 | `variable_completeness >= 50` | "可变层完整度不足，请完善偏好设置" |
| 子报告D | D1 | 核心层通用技能 | `universal_skills IS NOT NULL AND length(universal_skills) > 0` | "请先进行通用技能评估" |
| 子报告D | D2 | 核心层CASVE历史 | `casve_history IS NOT NULL AND length(casve_history) > 0` | "请至少完成一轮CASVE决策循环" |
| 完整报告 | F1 | 总完整度 | `total_completeness >= 70` | "整体画像完整度不足，请完善更多维度" |
| 完整报告 | F2 | 所有子报告条件 | `A1 AND A2 AND B1 AND C1 AND D1` | "请先完成各子报告的生成条件" |

### 5.2 条件检查实现

```python
class ReportPrerequisitesChecker:
    """报告生成条件检查器"""
    
    PREREQUISITES = {
        'SUB_REPORT_A': ['A1', 'A2'],
        'SUB_REPORT_B': ['B1', 'B2'],
        'SUB_REPORT_C': ['C1', 'C2', 'C3'],
        'SUB_REPORT_D': ['D1', 'D2'],
        'FULL_REPORT': ['F1', 'F2', 'A1', 'A2', 'B1', 'C1', 'D1']
    }
    
    def check(self, report_type: str, user_id: str) -> dict:
        """检查指定报告类型的生成条件"""
        user_data = self._fetch_user_data(user_id)
        
        results = {
            'can_generate': True,
            'passed': [],
            'failed': [],
            'recommendations': []
        }
        
        for condition_id in self.PREREQUISITES[report_type]:
            check_result = self._check_condition(condition_id, user_data)
            if check_result['passed']:
                results['passed'].append(condition_id)
            else:
                results['failed'].append({
                    'condition_id': condition_id,
                    'message': check_result['message'],
                    'recommendation': check_result['recommendation']
                })
                results['can_generate'] = False
        
        return results
```

---

## 六、用户界面设计

### 6.1 界面流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户报告模块界面流程                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐                                                        │
│  │  已有界面入口    │                                                        │
│  │  Entry Points   │                                                        │
│  │                 │                                                        │
│  │ • 导航栏"我的报告"按钮                                                   │
│  │ • 用户画像页"生成报告"卡片                                               │
│  │ • 专业详情页"查看相关报告"按钮                                           │
│  └────────┬────────┘                                                        │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    报告中心页 (report-center.html)                    │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  报告概览卡片                                                 │   │   │
│  │  │  • 已生成报告数量                                             │   │   │
│  │  │  • 最近生成时间                                               │   │   │
│  │  │  • 完整度进度条                                               │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  生成条件检查面板                                             │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │   │   │
│  │  │  │子报告A  │ │子报告B  │ │子报告C  │ │子报告D  │            │   │   │
│  │  │  │[条件检查]│ │[条件检查]│ │[条件检查]│ │[条件检查]│            │   │   │
│  │  │  │[生成按钮]│ │[生成按钮]│ │[生成按钮]│ │[生成按钮]│            │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘            │   │   │
│  │  │  [生成完整报告 - 需满足所有条件]                              │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  历史报告列表                                                 │   │   │
│  │  │  • 报告名称 | 生成日期 | 类型 | 操作(查看/下载/删除)          │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│           │                                                                 │
│           │ 点击"生成"按钮                                                  │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                 报告生成页 (report-generation.html)                   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  生成进度面板                                                  │   │   │
│  │  │  [████████████████░░░░░░░░░░░░] 65%                          │   │   │
│  │  │  当前阶段: 正在生成第三章...                                   │   │   │
│  │  │  预计剩余时间: 约2分钟                                         │   │   │
│  │  │  [取消生成]                                                   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  章节生成状态                                                  │   │   │
│  │  │  ✓ 第二章 - 用户画像分析 (已完成)                              │   │   │
│  │  │  ✓ 第三章 - 表单分析 (已完成)                                  │   │   │
│  │  │  ⟳ 第四章 - 三层建模 (生成中...)                               │   │   │
│  │  │  ○ 第五章 - 行动体系 (等待中)                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│           │                                                                 │
│           │ 生成完成                                                        │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                  报告阅读页 (report-viewer.html)                      │   │
│  │                                                                     │   │
│  │  ┌──────────┬───────────────────────────────────────────────────┐  │   │
│  │  │          │                                                   │  │   │
│  │  │  章节    │              报告内容区域                          │  │   │
│  │  │  导航    │                                                   │  │   │
│  │  │          │  - 富文本渲染                                       │  │   │
│  │  │  - 目录  │  - 交互式图表                                       │  │   │
│  │  │  - 缩略  │  - 高亮与批注                                       │  │   │
│  │  │    图    │  - 内链跳转                                         │  │   │
│  │  │          │                                                   │  │   │
│  │  │ [导出]   │                                                   │  │   │
│  │  │ [打印]   │                                                   │  │   │
│  │  │ [分享]   │                                                   │  │   │
│  │  └──────────┴───────────────────────────────────────────────────┘  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 页面设计要点

| 页面 | 核心功能 | 设计要点 |
|-----|---------|---------|
| **报告中心页** | 条件检查、生成入口、历史管理 | 条件卡片可视化、进度直观展示、操作便捷 |
| **报告生成页** | 实时进度、章节状态、取消控制 | WebSocket实时推送、状态清晰、可中断 |
| **报告阅读页** | 内容展示、章节导航、交互操作 | 类似PDF阅读器体验、响应式布局、导出便捷 |

---

## 七、模块独立性设计

### 7.1 依赖边界

```
用户报告模块依赖关系:

用户报告模块 ─────────────────────────────────────────────┐
│                                                         │
├─► 用户画像模块 (只读)                                     │
│   • UserProfile 表                                       │
│   • 三层模型数据 (接口层/可变层/核心层)                     │
│                                                         │
├─► 用户表单模块 (只读)                                     │
│   • user_profile_logs 表                                 │
│   • 表单提交历史                                          │
│                                                         │
├─► 专业数据模块 (只读)                                     │
│   • majors 表                                            │
│   • disciplines 表                                       │
│                                                         │
├─► 职业数据模块 (只读)                                     │
│   • occupations 表                                       │
│   • career_paths 表                                      │
│                                                         │
└─► LazyLLM 服务 (调用)                                    │
    • 报告生成工作流                                        │
    • 章节内容生成                                          │
                                                            │
【不影响】──────────────────────────────────────────────────┤
                                                            │
✗ 用户画像模块的修改逻辑 (如表单提交、chat对话)                │
✗ 专业详情模块的展示逻辑                                     │
✗ 职业详情模块的数据结构                                     │
                                                            │
【新增】────────────────────────────────────────────────────┤
                                                            │
✓ report_metadata 表 - 报告元数据                           │
✓ report_chapters 表 - 报告章节内容                          │
✓ report_generation_jobs 表 - 生成任务队列                    │
```

### 7.2 接口隔离

```python
# 用户报告模块对外提供的接口
class UserReportModule:
    """
    用户报告模块 - 对外接口定义
    
    本模块仅暴露以下接口，所有内部实现细节对外部不可见
    """
    
    # ========== 条件检查接口 ==========
    async def check_prerequisites(self, user_id: str, report_type: str) -> PrerequisitesResult:
        """检查报告生成条件"""
        pass
    
    # ========== 报告生成接口 ==========
    async def start_generation(self, user_id: str, report_type: str) -> GenerationTask:
        """启动报告生成任务"""
        pass
    
    async def get_generation_status(self, task_id: str) -> GenerationStatus:
        """获取生成任务状态"""
        pass
    
    async def cancel_generation(self, task_id: str) -> bool:
        """取消生成任务"""
        pass
    
    # ========== 报告查询接口 ==========
    async def get_report_list(self, user_id: str) -> List[ReportMetadata]:
        """获取用户报告列表"""
        pass
    
    async def get_report_content(self, report_id: str) -> ReportContent:
        """获取报告内容"""
        pass
    
    async def get_chapter_content(self, report_id: str, chapter_id: str) -> ChapterContent:
        """获取单个章节内容"""
        pass
    
    # ========== 报告导出接口 ==========
    async def export_pdf(self, report_id: str) -> FileStream:
        """导出PDF格式"""
        pass
    
    async def export_word(self, report_id: str) -> FileStream:
        """导出Word格式"""
        pass
    
    async def export_markdown(self, report_id: str) -> str:
        """导出Markdown格式"""
        pass
```

---

## 八、错误处理与降级策略

### 8.1 错误分类与处理

| 错误类型 | 场景 | 处理策略 |
|---------|------|---------|
| **前置条件不满足** | 用户画像数据不足 | 返回详细缺失项清单，引导用户补充 |
| **LLM服务不可用** | LazyLLM调用失败 | 返回友好错误提示，建议稍后重试 |
| **生成超时** | 单章节生成超过5分钟 | 自动重试1次，失败则标记为"生成失败" |
| **内容质量不达标** | 生成字数不足或逻辑混乱 | 触发二次生成，记录质量问题 |
| **存储失败** | 数据库写入错误 | 重试3次，失败则返回错误，保留内存数据 |

### 8.2 降级策略

```
完整功能降级路径:

Level 0: 正常模式
  └── 并行生成所有章节 → 质量校验 → 完整报告

Level 1: 降级模式A (部分LLM不可用)
  └── 串行生成章节 → 跳过质量校验 → 基础报告

Level 2: 降级模式B (LLM完全不可用)
  └── 返回模板报告 (基于用户数据填充模板) → 提示用户

Level 3: 紧急模式
  └── 仅返回报告框架大纲 → 建议用户稍后重试
```

---

## 九、性能设计

### 9.1 生成时间预估

| 报告类型 | 章节数量 | 预估生成时间 | 并行优化后 |
|---------|---------|-------------|-----------|
| 子报告A | 4个子章节 | ~3分钟 | ~1.5分钟 (4并行) |
| 子报告B | 4个章节 | ~2.5分钟 | ~1.2分钟 (4并行) |
| 子报告C | 8个子章节 | ~6分钟 | ~2分钟 (5并行) |
| 子报告D | 8个子章节 | ~5分钟 | ~1.8分钟 (5并行) |
| 完整报告 | 25+章节 | ~20分钟 | ~5分钟 (5并行+流水线) |

### 9.2 资源消耗预估

| 资源类型 | 单次生成消耗 | 并发10用户 | 优化策略 |
|---------|-------------|-----------|---------|
| LLM Tokens | ~150K tokens | ~1.5M tokens | 章节缓存、增量更新 |
| 数据库写入 | ~50条记录 | ~500条记录 | 批量写入、异步持久化 |
| 内存占用 | ~100MB | ~1GB | 流式处理、分块加载 |
| 存储空间 | ~500KB/报告 | ~5MB | 压缩存储、定期归档 |

---

## 十、安全与隐私设计

### 10.1 数据安全

- **敏感信息脱敏**: 报告中涉及的个人隐私数据进行脱敏处理
- **访问控制**: 用户只能查看自己的报告，API严格鉴权
- **传输加密**: 报告内容传输使用HTTPS
- **存储加密**: 数据库敏感字段加密存储

### 10.2 隐私保护

- **报告删除**: 用户可彻底删除报告，数据库级联清理
- **导出水印**: PDF/Word导出添加用户标识水印
- **访问日志**: 记录报告查看/导出操作，用于审计

---

## 十一、文档清单

本模块设计交付以下文档：

| 文档 | 路径 | 状态 |
|-----|------|-----|
| 模块设计文档 | `doc/user-report-module/design.md` | ✅ 本文件 |
| API接口文档 | `doc/user-report-module/api.md` | 📝 待创建 |
| 数据库设计文档 | `doc/user-report-module/database.md` | 📝 待创建 |
| 更新日志 | `doc/user-report-module/log-20260209-v1.0.md` | 📝 待创建 |

---

## 十二、实现计划

### Phase 1: 基础设施 (Week 1)
- [ ] 数据库表设计实现
- [ ] 基础实体类定义
- [ ] 条件检查器实现

### Phase 2: 生成引擎 (Week 2)
- [ ] LazyLLM工作流搭建
- [ ] 章节生成器实现
- [ ] 质量校验模块

### Phase 3: API层 (Week 3)
- [ ] 条件检查API
- [ ] 生成任务API
- [ ] 报告查询API
- [ ] 导出API

### Phase 4: 前端界面 (Week 4)
- [ ] 报告中心页
- [ ] 报告生成页
- [ ] 报告阅读页

### Phase 5: 集成测试 (Week 5)
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 用户验收测试

---

**文档结束**
