# -*- coding: utf-8 -*-
"""
08 学科门类：工学 - B部分
包含：土木类、水利类、测绘类、化工与制药类、地质类、矿业类、纺织类、轻工类
"""

import sys
import os
import json

backend_path = 'D:/github.com/carrotmet/zyplusv2/backend'
if backend_path not in sys.path:
    sys.path.insert(0, backend_path)
os.chdir(backend_path)

from app.database import SessionLocal
from app import models

def get_or_create_discipline(db, name, code, description):
    discipline = db.query(models.Discipline).filter(models.Discipline.code == code).first()
    if not discipline:
        discipline = models.Discipline(name=name, code=code, description=description)
        db.add(discipline)
        db.commit()
        db.refresh(discipline)
        print(f"  创建学科门类: {name} (ID: {discipline.id})")
    else:
        print(f"  学科门类已存在: {name} (ID: {discipline.id})")
    return discipline

def get_or_create_category(db, name, code, discipline_id, description):
    category = db.query(models.MajorCategory).filter(
        models.MajorCategory.code == code,
        models.MajorCategory.discipline_id == discipline_id
    ).first()
    if not category:
        category = models.MajorCategory(name=name, code=code, discipline_id=discipline_id, description=description)
        db.add(category)
        db.commit()
        db.refresh(category)
        print(f"    创建专业类: {name} (ID: {category.id})")
    else:
        print(f"    专业类已存在: {name} (ID: {category.id})")
    return category

def create_major_if_not_exists(db, name, code, category_id, description, duration, courses):
    existing = db.query(models.Major).filter(models.Major.code == code).first()
    if existing:
        print(f"      跳过: {name} (已存在)")
        return None
    major = models.Major(name=name, code=code, category_id=category_id, description=description,
                        duration=duration, main_courses=json.dumps(courses, ensure_ascii=False))
    db.add(major)
    db.commit()
    db.refresh(major)
    print(f"      创建专业: {name} (ID: {major.id})")
    return major

def init_engineering_b_data():
    print("=== 初始化 08 工学类数据（B：土木水利测绘化工地质矿业纺织轻工）===\n")
    db = SessionLocal()
    try:
        discipline = get_or_create_discipline(db, "工学", "08", "工学学科门类")
        
        # 0810 土木类
        cat = get_or_create_category(db, "土木类", "0810", discipline.id, "研究土木工程结构设计与施工的学科")
        majors = [
            ("土木工程", "081001", "培养从事土木工程设计施工管理的专业人才", ["结构力学", "混凝土结构", "钢结构", "土力学", "基础工程", "施工技术", "工程测量"]),
            ("建筑环境与能源应用工程", "081002", "培养从事建筑环境与能源应用的专业人才", ["传热学", "流体力学", "暖通空调", "供热工程", "制冷技术", "建筑节能", "可再生能源"]),
            ("给排水科学与工程", "081003", "培养从事给排水科学与工程的专业人才", ["水力学", "水处理工程", "给水工程", "排水工程", "建筑给排水", "水工艺设备", "水质分析"]),
            ("建筑电气与智能化", "081004", "培养从事建筑电气与智能化的专业人才", ["电路原理", "电机与拖动", "供配电", "照明工程", "建筑智能化", "楼宇自控", "消防工程"]),
            ("城市地下空间工程", "081005T", "培养从事城市地下空间工程的专业人才", ["地下建筑结构", "岩土工程", "隧道工程", "地铁工程", "地下综合管廊", "基坑工程", "地下施工"]),
            ("道路桥梁与渡河工程", "081006T", "培养从事道路桥梁与渡河工程的专业人才", ["道路勘测设计", "路基路面工程", "桥梁工程", "隧道工程", "渡河工程", "交通工程", "施工组织"]),
            ("铁道工程", "081007T", "培养从事铁道工程的专业人才", ["铁路线路", "轨道工程", "桥梁工程", "隧道工程", "路基工程", "铁路车站", "铁路施工"]),
            ("智能建造", "081008T", "培养从事智能建造的专业人才", ["BIM技术", "智能施工", "建筑机器人", "数字孪生", "装配式建筑", "智慧工地", "建造信息化"]),
            ("土木、水利与海洋工程", "081009T", "培养从事土木水利与海洋工程的复合人才", ["土木工程", "水利工程", "海洋工程", "结构分析", "流体力学", "海岸工程", "防灾减灾"]),
            ("土木、水利与交通工程", "081010T", "培养从事土木水利与交通工程的复合人才", ["土木工程", "水利工程", "交通工程", "道路工程", "桥梁工程", "港口航道", "综合交通"]),
            ("城市水系统工程", "081011T", "培养从事城市水系统工程的专业人才", ["水系统规划", "给排水", "海绵城市", "水环境治理", "智慧水务", "水资源利用", "防洪排涝"]),
            ("智能建造与智慧交通", "081012T", "培养从事智能建造与智慧交通的复合人才", ["智能建造", "智慧交通", "BIM", "交通信息化", "车路协同", "自动驾驶", "智慧城市"]),
            ("工程软件", "081013T", "培养从事工程软件开发的专业人才", ["工程计算", "CAE", "BIM软件开发", "数值分析", "图形学", "工程数据库", "工程AI"]),
        ]
        for name, code, desc, courses in majors:
            create_major_if_not_exists(db, name, code, cat.id, desc, 4, courses)
        
        # 0811 水利类
        cat2 = get_or_create_category(db, "水利类", "0811", discipline.id, "研究水利工程技术的学科")
        majors2 = [
            ("水利水电工程", "081101", "培养从事水利水电工程的专业人才", ["水工建筑物", "水电站", "水利施工", "工程水文", "水利机械", "水电站自动化", "库区移民"]),
            ("水文与水资源工程", "081102", "培养从事水文与水资源工程的专业人才", ["水文学原理", "水文预报", "水资源规划", "水环境", "地下水", "水资源管理", "水信息技术"]),
            ("港口航道与海岸工程", "081103", "培养从事港口航道与海岸工程的专业人才", ["港口工程", "航道工程", "海岸工程", "水工结构", "河口治理", "疏浚工程", "近海工程"]),
            ("水务工程", "081104T", "培养从事水务工程的专业人才", ["水系统规划", "给排水", "水资源", "水环境", "智慧水务", "水务管理", "节水技术"]),
            ("水利科学与工程", "081105T", "培养从事水利科学与工程的专业人才", ["水利工程", "水科学", "水生态", "水环境", "水资源", "防洪减灾", "智慧水利"]),
            ("智慧水利", "081106T", "培养从事智慧水利的专业人才", ["水利工程", "信息技术", "物联网", "大数据", "人工智能", "数字孪生", "智慧调度"]),
        ]
        for name, code, desc, courses in majors2:
            create_major_if_not_exists(db, name, code, cat2.id, desc, 4, courses)
        
        # 0812 测绘类
        cat3 = get_or_create_category(db, "测绘类", "0812", discipline.id, "研究地球空间信息采集处理的学科")
        majors3 = [
            ("测绘工程", "081201", "培养从事测绘工程的专业人才", ["测量学", "控制测量", "工程测量", "摄影测量", "GIS", "GPS原理", "误差理论"]),
            ("遥感科学与技术", "081202", "培养从事遥感科学与技术的专业人才", ["遥感原理", "摄影测量", "图像处理", "GIS", "遥感应用", "定量遥感", "高光谱遥感"]),
            ("导航工程", "081203T", "培养从事导航工程的专业人才", ["导航原理", "卫星导航", "惯性导航", "组合导航", "地图学", "位置服务", "智能驾驶导航"]),
            ("地理国情监测", "081204T", "培养从事地理国情监测的专业人才", ["遥感", "GIS", "测绘", "统计分析", "变化检测", "国情评估", "报告编制"]),
            ("地理空间信息工程", "081205T", "培养从事地理空间信息工程的专业人才", ["GIS", "遥感", "空间数据库", "空间分析", "地图学", "位置服务", "空间大数据"]),
            ("时空信息工程", "081206TK", "培养从事时空信息工程的专业人才", ["时空基准", "北斗导航", "高精度地图", "时空大数据", "位置智能", "数字孪生", "智慧城市"]),
        ]
        for name, code, desc, courses in majors3:
            create_major_if_not_exists(db, name, code, cat3.id, desc, 4, courses)
        
        # 0813 化工与制药类
        cat4 = get_or_create_category(db, "化工与制药类", "0813", discipline.id, "研究化工与制药技术的学科")
        majors4 = [
            ("化学工程与工艺", "081301", "培养从事化学工程与工艺的专业人才", ["化工原理", "反应工程", "分离工程", "化工热力学", "工艺设计", "化工设备", "过程控制"]),
            ("制药工程", "081302", "培养从事制药工程的专业人才", ["药物化学", "药剂学", "制药工艺", "制药设备", "GMP", "药物分析", "药品生产"]),
            ("资源循环科学与工程", "081303T", "培养从事资源循环科学与工程的专业人才", ["资源循环", "再生资源", "固废处理", "清洁生产", "生态设计", "循环经济", "碳管理"]),
            ("能源化学工程", "081304T", "培养从事能源化学工程的专业人才", ["能源化工", "煤化工", "石油化工", "天然气", "新能源", "储能技术", "燃料电池"]),
            ("化学工程与工业生物工程", "081305T", "培养从事化学工程与工业生物工程的专业人才", ["化工原理", "生物工程", "生化反应", "分离技术", "生物催化", "合成生物学", "工业生物技术"]),
            ("化工安全工程", "081306T", "培养从事化工安全工程的专业人才", ["化工安全", "过程安全", "风险评估", "应急管理", "安全设计", "HSE管理", "事故调查"]),
            ("涂料工程", "081307T", "培养从事涂料工程的专业人才", ["涂料化学", "涂料配方", "涂装工艺", "涂料检测", "色彩学", "防腐涂料", "功能涂料"]),
            ("精细化工", "081308T", "培养从事精细化工的专业人才", ["精细化工", "日用化工", "电子化学品", "农药", "染料", "涂料", "催化剂"]),
            ("智能分子工程", "081309T", "培养从事智能分子工程的专业人才", ["分子设计", "计算化学", "AI制药", "智能合成", "高通量筛选", "分子模拟", "知识图谱"]),
        ]
        for name, code, desc, courses in majors4:
            create_major_if_not_exists(db, name, code, cat4.id, desc, 4, courses)
        
        # 0814 地质类
        cat5 = get_or_create_category(db, "地质类", "0814", discipline.id, "研究地质工程技术的学科")
        majors5 = [
            ("地质工程", "081401", "培养从事地质工程的专业人才", ["工程地质", "岩土工程", "地质勘察", "地质灾害", "地基处理", "地下工程", "边坡工程"]),
            ("勘查技术与工程", "081402", "培养从事勘查技术与工程的专业人才", ["地球物理勘探", "地球化学勘探", "钻探工程", "岩土钻掘", "地质雷达", "测井技术", "遥感"]),
            ("资源勘查工程", "081403K", "培养从事资源勘查工程的专业人才", ["矿产勘查", "石油天然气勘查", "煤田勘查", "地质学", "矿床学", "勘查技术", "资源评价"]),
            ("地下水科学与工程", "081404T", "培养从事地下水科学与工程的专业人才", ["水文地质", "地下水动力学", "地下水污染", "水资源评价", "工程水文地质", "地下水模拟", "生态修复"]),
            ("旅游地学与规划工程", "081405T", "培养从事旅游地学与规划工程的专业人才", ["地质学", "旅游学", "景区规划", "地质公园", "自然遗产", "生态旅游", "地质旅游"]),
            ("智能地球探测", "081406T", "培养从事智能地球探测的专业人才", ["地球物理", "人工智能", "大数据", "智能勘探", "地球物理仪器", "数据处理", "智能解译"]),
            ("资源环境大数据工程", "081407T", "培养从事资源环境大数据工程的专业人才", ["资源环境", "大数据技术", "空间分析", "数据挖掘", "机器学习", "GIS", "云计算"]),
        ]
        for name, code, desc, courses in majors5:
            create_major_if_not_exists(db, name, code, cat5.id, desc, 4, courses)
        
        # 0815 矿业类
        cat6 = get_or_create_category(db, "矿业类", "0815", discipline.id, "研究矿产资源开发的学科")
        majors6 = [
            ("采矿工程", "081501", "培养从事采矿工程的专业人才", ["采矿学", "矿山压力", "井巷工程", "矿井通风", "矿山安全", "露天开采", "数字矿山"]),
            ("石油工程", "081502", "培养从事石油工程的专业人才", ["油层物理", "采油工程", "钻井工程", "油藏工程", "油田化学", "海洋石油", "非常规油气"]),
            ("矿物加工工程", "081503", "培养从事矿物加工工程的专业人才", ["破碎磨矿", "物理分选", "浮选", "矿物化学", "粉体工程", "尾矿处理", "资源综合利用"]),
            ("油气储运工程", "081504", "培养从事油气储运工程的专业人才", ["油气集输", "长输管道", "油库设计", "城市燃气", "LNG技术", "管道腐蚀", "安全管理"]),
            ("矿物资源工程", "081505T", "培养从事矿物资源工程的专业人才", ["资源工程", "采矿", "选矿", "资源评价", "资源经济", "资源环境", "资源管理"]),
            ("海洋油气工程", "081506T", "培养从事海洋油气工程的专业人才", ["海洋工程", "海洋钻采", "海洋平台", "海底管道", "海洋油气集输", "海洋环境", "安全工程"]),
            ("智能采矿工程", "081507T", "培养从事智能采矿工程的专业人才", ["智能采矿", "无人采矿", "矿山物联网", "智能装备", "数字孪生", "矿山大数据", "智能决策"]),
            ("碳储科学与工程", "081508TK", "培养从事碳储科学与工程的专业人才", ["碳捕集", "碳利用", "碳封存", "碳监测", "碳管理", "碳经济", "CCUS技术"]),
        ]
        for name, code, desc, courses in majors6:
            create_major_if_not_exists(db, name, code, cat6.id, desc, 4, courses)
        
        # 0816 纺织类
        cat7 = get_or_create_category(db, "纺织类", "0816", discipline.id, "研究纺织工程技术的学科")
        majors7 = [
            ("纺织工程", "081601", "培养从事纺织工程的专业人才", ["纺织材料", "纺纱学", "织造学", "针织学", "非织造", "纺织品设计", "纺织贸易"]),
            ("服装设计与工程", "081602", "培养从事服装设计与工程的专业人才", ["服装设计", "服装结构", "服装工艺", "服装CAD", "服装生产", "服装营销", "服装史"]),
            ("非织造材料与工程", "081603T", "培养从事非织造材料与工程的专业人才", ["非织造原理", "成网技术", "加固技术", "后整理", "产业用纺织品", "过滤材料", "医用材料"]),
            ("服装设计与工艺教育", "081604T", "培养从事服装设计与工艺教育的专业人才", ["服装设计", "服装工艺", "教育学", "教学法", "技能训练", "课程开发", "职业教育"]),
            ("丝绸设计与工程", "081605T", "培养从事丝绸设计与工程的专业人才", ["丝绸材料", "丝绸工艺", "丝绸设计", "丝绸文化", "丝绸贸易", "丝绸史", "创新设计"]),
        ]
        for name, code, desc, courses in majors7:
            create_major_if_not_exists(db, name, code, cat7.id, desc, 4, courses)
        
        # 0817 轻工类
        cat8 = get_or_create_category(db, "轻工类", "0817", discipline.id, "研究轻工技术与工程的学科")
        majors8 = [
            ("轻化工程", "081701", "培养从事轻化工程的专业人才", ["制浆造纸", "皮革工程", "染整工程", "轻化工", "清洁生产", "功能材料", "质量控制"]),
            ("包装工程", "081702", "培养从事包装工程的专业人才", ["包装材料", "包装工艺", "包装机械", "包装印刷", "运输包装", "销售包装", "智能包装"]),
            ("印刷工程", "081703", "培养从事印刷工程的专业人才", ["印刷原理", "印刷材料", "制版技术", "印刷机械", "数字印刷", "色彩管理", "印刷质量"]),
            ("香料香精技术与工程", "081704T", "培养从事香料香精技术与工程的专业人才", ["香料化学", "香精调配", "香气分析", "日用香精", "食用香精", "烟草香精", "天然香料"]),
            ("化妆品技术与工程", "081705T", "培养从事化妆品技术与工程的专业人才", ["化妆品学", "化妆品配方", "化妆品工艺", "化妆品原料", "化妆品评价", "化妆品法规", "化妆品营销"]),
            ("生物质能源与材料", "081706TK", "培养从事生物质能源与材料的专业人才", ["生物质化学", "生物质能源", "生物基材料", "生物炼制", "生物燃料", "生物降解", "碳中和"]),
            ("生物质技术与工程", "081707T", "培养从事生物质技术与工程的专业人才", ["生物质转化", "生物发酵", "生物分离", "生物能源", "生物材料", "环境工程", "循环经济"]),
        ]
        for name, code, desc, courses in majors8:
            create_major_if_not_exists(db, name, code, cat8.id, desc, 4, courses)
        
        print("\n=== 工学类数据（B部分）初始化完成 ===")
    finally:
        db.close()

if __name__ == "__main__":
    init_engineering_b_data()
