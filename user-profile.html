<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户画像 - 职业规划导航</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-blue: #4A90E4;
            --light-blue: #7BB3F0;
            --pale-blue: #A8C8EC;
            --very-light-blue: #D6E3F8;
            --interface-layer: #4A90E4;
            --variable-layer: #50C878;
            --core-layer: #9B59B6;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, var(--very-light-blue) 0%, #F8FAFC 100%);
            min-height: 100vh;
        }
        
        /* 层级卡片样式 */
        .layer-card {
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .layer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        
        .interface-layer {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 4px solid var(--interface-layer);
        }
        
        .variable-layer {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-left: 4px solid var(--variable-layer);
        }
        
        .core-layer {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            border-left: 4px solid var(--core-layer);
        }
        
        /* 聊天区域 */
        .chat-container {
            height: 500px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .chat-message {
            max-width: 80%;
            margin-bottom: 12px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            margin-left: auto;
            background: var(--primary-blue);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }
        
        .ai-message {
            margin-right: auto;
            background: white;
            border: 1px solid var(--pale-blue);
            border-radius: 16px 16px 16px 4px;
        }
        
        /* 完整度指示器 */
        .completeness-bar {
            height: 8px;
            border-radius: 4px;
            background: #E0E0E0;
            overflow: hidden;
        }
        
        .completeness-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
        }
        
        /* CASVE进度 */
        .casve-stage {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .casve-active {
            background: var(--primary-blue);
            color: white;
        }
        
        .casve-inactive {
            background: #E0E0E0;
            color: #666;
        }
        
        /* 快捷意图按钮 */
        .intent-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--pale-blue);
            background: white;
            color: var(--primary-blue);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .intent-btn:hover {
            background: var(--primary-blue);
            color: white;
        }
        
        /* 属性标签 */
        .attribute-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin: 4px;
        }
        
        .tag-interface { background: #E3F2FD; color: #1976D2; }
        .tag-variable { background: #E8F5E9; color: #388E3C; }
        .tag-core { background: #F3E5F5; color: #7B1FA2; }
        
        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F5F5F5;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--pale-blue);
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-xl font-bold text-blue-600">
                        <i class="fas fa-compass mr-2"></i>职业规划导航
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6 mr-4">
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 transition-colors">专业选择</a>
                    <a href="major-detail.html" class="text-gray-600 hover:text-blue-600 transition-colors">职业详情</a>
                    <a href="report-center.html" class="text-blue-600 font-medium border-b-2 border-blue-600 pb-1">我的报告</a>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="user-greeting">你好，用户</span>
                    <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white" id="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition-colors" title="退出登录">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- 左侧: AI对话区 -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <!-- 头部 -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center text-white">
                            <i class="fas fa-robot text-2xl mr-3"></i>
                            <div>
                                <h3 class="font-semibold">AI职业规划助手</h3>
                                <p class="text-xs text-blue-100">基于专业理论提供个性化建议</p>
                            </div>
                        </div>
                        <button onclick="clearChat()" class="text-white hover:text-blue-100" title="清除对话">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 对话历史 -->
                <div class="chat-container p-4 bg-gray-50" id="chat-history">
                    <!-- 欢迎消息 -->
                    <div class="chat-message ai-message p-4">
                        <div class="flex items-start">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white mr-3 flex-shrink-0">
                                <i class="fas fa-robot text-sm"></i>
                            </div>
                            <div>
                                <p class="text-gray-800">你好！我是你的职业规划助手。我可以帮助你：</p>
                                <ul class="mt-2 text-sm text-gray-600 space-y-1">
                                    <li>• 探索兴趣和性格特点</li>
                                    <li>• 评估能力和优势</li>
                                    <li>• 澄清职业价值观</li>
                                    <li>• 规划职业发展路径</li>
                                </ul>
                                <p class="mt-3 text-gray-800">我们可以从任何你感兴趣的话题开始聊！</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 快捷意图按钮 -->
                <div class="px-4 py-2 bg-gray-50 border-t">
                    <div class="flex flex-wrap gap-2">
                        <button class="intent-btn" onclick="sendIntent('我想探索我的兴趣')">
                            <i class="fas fa-heart mr-1"></i>兴趣探索
                        </button>
                        <button class="intent-btn" onclick="sendIntent('我想了解我的能力优势')">
                            <i class="fas fa-star mr-1"></i>能力评估
                        </button>
                        <button class="intent-btn" onclick="sendIntent('我重视的工作价值是什么')">
                            <i class="fas fa-gem mr-1"></i>价值观
                        </button>
                        <button class="intent-btn" onclick="sendIntent('给我一些职业建议')">
                            <i class="fas fa-briefcase mr-1"></i>职业建议
                        </button>
                    </div>
                </div>
                
                <!-- 输入区 -->
                <div class="p-4 border-t">
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="chat-input"
                            class="flex-1 px-4 py-2 border border-gray-200 rounded-full focus:outline-none focus:border-blue-500"
                            placeholder="输入消息..."
                            onkeypress="handleKeyPress(event)"
                        >
                        <button 
                            onclick="sendMessage()"
                            class="w-10 h-10 rounded-full bg-blue-500 text-white hover:bg-blue-600 flex items-center justify-center transition-colors"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧: 画像可视化 -->
            <div class="space-y-6">
                <!-- 完整度概览 -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">画像完整度</h3>
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-bold text-blue-600" id="completeness-score">0%</span>
                            <button 
                                onclick="openProfileForm()" 
                                class="px-3 py-1.5 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 transition-colors flex items-center"
                                title="完善你的用户画像信息"
                            >
                                <i class="fas fa-edit mr-1.5"></i>填写
                            </button>
                        </div>
                    </div>
                    <div class="completeness-bar mb-4">
                        <div class="completeness-fill" id="completeness-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>接口层: <span id="interface-score">0</span>%</span>
                        <span>可变层: <span id="variable-score">0</span>%</span>
                        <span>核心层: <span id="core-score">0</span>%</span>
                    </div>
                </div>
                
                <!-- CASVE状态 -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-route mr-2 text-blue-500"></i>CASVE决策进程
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="casve-stage casve-active" id="stage-C">C-沟通</span>
                        <span class="casve-stage casve-inactive" id="stage-A">A-分析</span>
                        <span class="casve-stage casve-inactive" id="stage-S">S-综合</span>
                        <span class="casve-stage casve-inactive" id="stage-V">V-评估</span>
                        <span class="casve-stage casve-inactive" id="stage-E">E-执行</span>
                    </div>
                    <p class="mt-4 text-sm text-gray-600" id="casve-description">
                        当前阶段：识别决策需求，感知理想与现实差距
                    </p>
                </div>
                
                <!-- 三层模型卡片 -->
                
                <!-- 接口层 -->
                <div class="layer-card interface-layer p-6" onclick="expandLayer('interface')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">接口层</h4>
                                <p class="text-xs text-gray-500">个性化输入</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div id="interface-content" class="layer-content">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white bg-opacity-60 rounded-lg p-3">
                                <p class="text-xs text-gray-500">霍兰德代码</p>
                                <p class="font-medium text-blue-600" id="holland-code">未设置</p>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-lg p-3">
                                <p class="text-xs text-gray-500">MBTI类型</p>
                                <p class="font-medium text-blue-600" id="mbti-type">未设置</p>
                            </div>
                        </div>
                        <div class="mt-3 bg-white bg-opacity-60 rounded-lg p-3">
                            <p class="text-xs text-gray-500">价值观优先级</p>
                            <div class="flex flex-wrap mt-1" id="value-tags">
                                <span class="text-sm text-gray-400">暂无数据</span>
                            </div>
                        </div>
                        <div class="mt-3 bg-white bg-opacity-60 rounded-lg p-3">
                            <p class="text-xs text-gray-500">能力评估</p>
                            <div class="mt-1" id="ability-bars">
                                <!-- 能力条将动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 可变层 -->
                <div class="layer-card variable-layer p-6" onclick="expandLayer('variable')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mr-3">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">可变层</h4>
                                <p class="text-xs text-gray-500">专业适配要素</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div id="variable-content" class="layer-content">
                        <div class="bg-white bg-opacity-60 rounded-lg p-3 mb-3">
                            <p class="text-xs text-gray-500">职业路径偏好</p>
                            <p class="font-medium text-green-600" id="career-path">未设置</p>
                        </div>
                        <div class="bg-white bg-opacity-60 rounded-lg p-3 mb-3">
                            <p class="text-xs text-gray-500">偏好专业</p>
                            <div class="flex flex-wrap mt-1" id="major-tags">
                                <span class="text-sm text-gray-400">暂无数据</span>
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-60 rounded-lg p-3">
                            <p class="text-xs text-gray-500">实践经历</p>
                            <div class="mt-1" id="practice-list">
                                <span class="text-sm text-gray-400">暂无数据</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 核心层 -->
                <div class="layer-card core-layer p-6" onclick="expandLayer('core')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">核心层</h4>
                                <p class="text-xs text-gray-500">跨专业不变要素</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                    <div id="core-content" class="layer-content">
                        <div class="bg-white bg-opacity-60 rounded-lg p-3 mb-3">
                            <p class="text-xs text-gray-500">通用技能</p>
                            <div class="mt-1" id="skill-bars">
                                <!-- 技能条将动态生成 -->
                            </div>
                        </div>
                        <div class="bg-white bg-opacity-60 rounded-lg p-3">
                            <p class="text-xs text-gray-500">职业弹性</p>
                            <div class="flex items-center mt-1">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-purple-500 h-2 rounded-full" id="resilience-bar" style="width: 0%"></div>
                                </div>
                                <span class="text-sm text-purple-600" id="resilience-score">0/10</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="profile-form.js"></script>
    <script src="user-profile.js"></script>
    <script>
        // 打开用户画像表单
        function openProfileForm() {
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                alert('请先登录');
                return;
            }
            
            // 获取当前显示的画像数据
            const currentData = {
                holland_code: document.getElementById('holland-code')?.textContent?.includes('未设置') ? '' : document.getElementById('holland-code')?.textContent,
                mbti_type: document.getElementById('mbti-type')?.textContent?.includes('未设置') ? '' : document.getElementById('mbti-type')?.textContent,
                career_path_preference: getCareerPathValue(),
                current_casve_stage: getCurrentCasveStage(),
                value_priorities: getValuePriorities(),
                ability_assessment: getAbilityAssessment(),
                universal_skills: getUniversalSkills(),
                resilience_score: getResilienceScore()
            };
            
            // 打开表单
            ProfileForm.open(userId, currentData, function(updatedData) {
                // 表单提交成功后的回调
                console.log('[ProfileForm] Updated data:', updatedData);
                // 刷新页面显示
                if (typeof updateUIFromProfileData === 'function') {
                    updateUIFromProfileData(updatedData);
                }
            });
        }
        
        // 获取职业路径值
        function getCareerPathValue() {
            const pathText = document.getElementById('career-path')?.textContent || '';
            const pathMap = {
                '技术专家路径': 'technical',
                '管理领导路径': 'management',
                '专业方向路径': 'professional',
                '公益方向路径': 'public_welfare'
            };
            return pathMap[pathText] || '';
        }
        
        // 获取当前CASVE阶段
        function getCurrentCasveStage() {
            const stages = ['C', 'A', 'S', 'V', 'E'];
            for (const s of stages) {
                const el = document.getElementById(`stage-${s}`);
                if (el && el.classList.contains('casve-active')) {
                    const stageMap = {
                        'C': 'communication',
                        'A': 'analysis',
                        'S': 'synthesis',
                        'V': 'evaluation',
                        'E': 'execution'
                    };
                    return stageMap[s];
                }
            }
            return 'communication';
        }
        
        // 获取价值观列表
        function getValuePriorities() {
            const container = document.getElementById('value-tags');
            if (!container) return [];
            const tags = container.querySelectorAll('.attribute-tag');
            return Array.from(tags).map(tag => tag.textContent.trim()).filter(t => t && t !== '暂无数据');
        }
        
        // 获取能力评估
        function getAbilityAssessment() {
            // 从全局状态获取
            if (typeof state !== 'undefined' && state.profile && state.profile.ability_assessment) {
                console.log('[getAbilityAssessment] Found:', state.profile.ability_assessment);
                return state.profile.ability_assessment;
            }
            console.log('[getAbilityAssessment] Not found, returning empty object');
            return {};
        }
        
        // 获取通用技能
        function getUniversalSkills() {
            if (typeof state !== 'undefined' && state.profile) {
                return state.profile.universal_skills || {};
            }
            return {};
        }
        
        // 获取职业弹性分数
        function getResilienceScore() {
            const scoreText = document.getElementById('resilience-score')?.textContent || '0/10';
            const match = scoreText.match(/(\d+)/);
            return match ? parseInt(match[1]) : 5;
        }
    </script>
</body>
</html>
