@echo off
chcp 65001 >nul
echo ================================================================================
echo                职业规划导航平台 - 一键启动开发环境
echo ================================================================================
echo.

REM 检查Python是否安装
python --version >nul 2>&1
if errorlevel 1 (
    echo [错误] 未检测到Python，请先安装Python 3.9+
    echo 下载地址: https://www.python.org/downloads/
    pause
    exit /b 1
)

echo [信息] Python环境检测成功

REM 获取当前目录
set SCRIPT_DIR=%~dp0
set BACKEND_DIR=%SCRIPT_DIR%backend

echo [信息] 项目目录: %SCRIPT_DIR%
echo [信息] 后端目录: %BACKEND_DIR%

REM 检查依赖文件
if not exist "%BACKEND_DIR%\requirements.txt" (
    echo [错误] 未找到 requirements.txt 文件
    pause
    exit /b 1
)

REM 检查HTML文件
if not exist "%SCRIPT_DIR%index.html" (
    echo [错误] 未找到 index.html 文件
    pause
    exit /b 1
)

REM 创建必要目录
if not exist "%SCRIPT_DIR%data" (
    echo [信息] 创建数据目录...
    mkdir "%SCRIPT_DIR%data" >nul 2>&1
)

if not exist "%SCRIPT_DIR%logs" (
    echo [信息] 创建日志目录...
    mkdir "%SCRIPT_DIR%logs" >nul 2>&1
)

REM 安装后端依赖
echo [信息] 检查后端依赖...
cd /d "%BACKEND_DIR%"
pip install -r requirements.txt -q >nul 2>&1

echo.
echo ================================================================================
echo                          选择启动模式
echo ================================================================================
echo.
echo   [1] 启动完整开发环境 (后端 + 前端)
echo   [2] 仅启动后端服务
echo   [3] 仅启动前端服务
echo   [4] 运行API测试
echo   [0] 退出
echo.
echo ================================================================================

set /p choice="请输入选项 [0-4]: "

if "%choice%"=="1" goto START_ALL
if "%choice%"=="2" goto START_BACKEND
if "%choice%"=="3" goto START_FRONTEND
if "%choice%"=="4" goto RUN_TEST
if "%choice%"=="0" exit /b 0

echo [错误] 无效选项
pause
exit /b 1

:START_ALL
echo.
echo [信息] 启动完整开发环境...
echo [提示] 将启动两个服务，请保持两个窗口运行
echo.

REM 启动后端服务
start "职业规划平台 - 后端服务" cmd /c "cd /d %BACKEND_DIR% && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
echo [信息] 后端服务已启动 (http://localhost:8000)

REM 等待后端启动
timeout /t 3 /nobreak >nul

REM 启动前端服务
start "职业规划平台 - 前端服务" cmd /c "python -m http.server 8001 --directory %SCRIPT_DIR%"
echo [信息] 前端服务已启动 (http://localhost:8001)

echo.
echo ================================================================================
echo                         开发环境已启动
echo ================================================================================
echo.
echo   前端地址: http://localhost:8001
echo   后端API: http://localhost:8000
echo   API文档: http://localhost:8000/docs
echo.
echo [提示] 1. 访问 http://localhost:8001 查看前端页面
echo [提示] 2. 访问 http://localhost:8000/docs 查看API文档
echo [提示] 3. 按 Ctrl+C 在对应窗口停止服务
echo ================================================================================
echo.
pause
exit /b 0

:START_BACKEND
echo.
echo [信息] 启动后端服务...
echo.
echo [信息] 服务地址: http://localhost:8000
echo [信息] API文档:  http://localhost:8000/docs
echo [提示] 按 Ctrl+C 停止服务
echo ================================================================================
echo.

cd /d "%BACKEND_DIR%"
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

pause
exit /b 0

:START_FRONTEND
echo.
echo [信息] 启动前端服务...
echo.
echo [信息] 服务地址: http://localhost:8001
echo [提示] 按 Ctrl+C 停止服务
echo ================================================================================
echo.

python -m http.server 8001 --directory "%SCRIPT_DIR%"

pause
exit /b 0

:RUN_TEST
echo.
echo [信息] 运行API测试...

REM 等待服务启动
timeout /t 3 /nobreak >nul

REM 运行测试脚本
cd /d "%SCRIPT_DIR%"
python test-api.py

pause
exit /b 0
